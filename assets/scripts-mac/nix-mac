#!/bin/bash

# Colors
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[1;34m'
NC='\033[0m'

HOSTNAME="MacBookAir10-1-jose-cribeiro"
CONF_NAME="darwinConfigurations.$HOSTNAME.system"

function switch {
    echo -e "${BLUE}Switch to generation${NC}"

    local success=false
    if which darwin-rebuild &> /dev/null; then
        sudo darwin-rebuild switch --flake ~/nixos-config#$HOSTNAME && success=true
    else
        echo -e "${BLUE}Build configuration${NC}"
        nix --extra-experimental-features 'nix-command flakes' build ~/nixos-config#$CONF_NAME;
        sudo ~/nixos-config/result/sw/bin/darwin-rebuild switch --flake ~/nixos-config#$HOSTNAME && success=true
    fi

    if [ "$success" = true ]; then
        echo -e "${GREEN}✓ Done${NC}"
        
        echo -e "${BLUE}Cleaning up${NC}"
        if [ -e ./result ]; then
            unlink ./result
        fi
        echo -e "${GREEN}✓ Done${NC}"
    else
        echo -e "${RED}✗ Switch failed${NC}"
        return 1
    fi
}

function list_generations {
    echo -e "${YELLOW}Available generations:${NC}"
    /run/current-system/sw/bin/darwin-rebuild --list-generations
}

function select_rollback {
    echo -e "${BLUE}Enter the generation number for rollback:${NC}"
    read GEN_NUM

    if [ -z "$GEN_NUM" ]; then
        echo -e "${RED}No generation number entered. Aborting rollback.${NC}"
        exit 1
    fi

    rollback $GEN_NUM
}

function rollback {
    echo -e "${YELLOW}Rolling back to generation $1...${NC}"
    if /run/current-system/sw/bin/darwin-rebuild switch --flake .#$HOSTNAME --switch-generation $1; then
        echo -e "${GREEN}✓ Done${NC}"
    else
        echo -e "${RED}✗ Rollback failed${NC}"
        return 1
    fi
}

function usage {
    echo "Usage: $(basename $0) [-s] [-l] [-r] [-h]"
    echo ""
    echo "Options:"
    echo "  -s    Switch to generation (build and activate)"
    echo "  -l    List generations"
    echo "  -r    List generations then rollback to selected"
    echo "  -h    Show this help message"
    echo ""
    echo "Note: For initial setup, use ./initial-setup.sh"
    exit 0
}

## Main
[ $# -eq 0 ] && usage
while getopts 'slrh' opt; do
    case "$opt" in
        s)
            switch
            ;;
        l)
            list_generations
            ;;
        r)
            list_generations
            select_rollback
            ;;
        ? | h)
            usage
        ;;
    esac
done